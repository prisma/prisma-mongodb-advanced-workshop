# Set up Prisma

## Goal

The goal of this lesson is to set up Prisma in your application, model out the data you’ll need for the next lesson, and create an instance of Prisma Client that you can import throughout your application.

## Setup

First, clone the [starter project from GitHub](https://github.com/sabinadams/prisma-mongodb-advanced-workshop) by following the instructions in the README. Once you've got the starter project on your machine, you can move on and create the database tables you need for this lesson.

## Tasks

After you’ve cloned the repo, installed all of the project’s dependencies, and made sure you have a database available, you should be good to go!

### Task 1: Initialize Prisma

The project’s starting point is completely running off of static data. There is no database involved, and because of that Prisma is not yet set up. 

Initialize Prisma in your project and connect it to your database. 

> **Hint:** The database’s connection string will be: `mongodb://root:prisma@localhost:27017/prisma-mongo?authSource=admin&retryWrites=true&w=majority`
> 
- Solution
    
    Run this command in your project’s directory:
    
    ```bash
    npx prisma init --datasource-provider mongodb
    ```
    
    In your `.env` file, add the following environment variable:
    
    ```json
    DATABASE_URL="mongodb://root:prisma@localhost:27017/prisma-mongo?authSource=admin&retryWrites=true&w=majority"
    ```
    

### Task 2: Create the `User` model

The [Prisma schema](https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-schema) is where you can define the shape of your data and how your individual collections relate to other collections.

This may seem strange as MongoDB is a *schemaless* database, however as your project grows in complexity, putting some set of guidelines in place make working with your data a lot simpler.

Your Prisma schema should currently look something like this:

```graphql
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}
```

Your `User` model will have these fields:

- `id`: The unique ID generated by MongoDB (named `_id` in the underlying database)
- `createdAt`: A timestamp set when the record is created
- `updatedAt`: A timestamp that updates whenever the record is updated
- `email`: The user’s email address
- `password`: The user’s password
- `profile`: An embedded document containing the fields:
    - `firstName`: The user’s first name
    - `lastName`: The user’s last name
- Solution
    
    ```graphql
    generator client {
      provider = "prisma-client-js"
    }
    
    datasource db {
      provider = "mongodb"
      url      = env("DATABASE_URL")
    }
    
    model User {
      id        String   @id @default(auto()) @map("_id") @db.ObjectId
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
      email     String   @unique
      password  String
    
      profile Profile
    }
    
    type Profile {
      firstName String
      lastName  String
    }
    ```
    

### Task 3: Push the new collection to MongoDB

Now that your schema is defined, you can use Prisma CLI to create the new collection inside of your database. Scan the [docs](https://www.prisma.io/docs/concepts/database-connectors/mongodb) to find the Prisma CLI command that allows you to push your schema changes. Once you've found the command, run it in your terminal.

- Solution
    
    ```graphql
    npx prisma db push
    ```
    

### Task 4: Instantiate Prisma Client in your application

You have a data model, you’ve pushed your new collections to your database, and Prisma Client was generated along the way. Now all you need to do before you can write some queries is instantiate Prisma Client so you can use it in your code!

Because your development server live-reloads, you will need to put in place guards against creating many connections to your database.

In your `app/utils` folder, create a new file named `prisma.server.ts` and paste in the following code:

```tsx
import { PrismaClient } from "@prisma/client";
let prisma: PrismaClient;
declare global {
  var __db: PrismaClient | undefined;
}

// this is needed because in development we don't want to restart
// the server with every change, but we want to make sure we don't
// create a new connection to the DB with every change either.
if (process.env.NODE_ENV === "production") {
  prisma = new PrismaClient();
  prisma.$connect();
} else {
  if (!global.__db) {
    global.__db = new PrismaClient();
    global.__db.$connect();
  }
  prisma = global.__db;
}

export * from "@prisma/client";
export { prisma };
```

This will instantiate Prisma Client and connect right away when in a production setting and export the client from the module. If you are not in production, however, it will only connect on the very first instantiation.

Take some time to look the code over and try to understand how it is accomplishing this.